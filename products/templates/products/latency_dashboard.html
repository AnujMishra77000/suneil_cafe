<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Latency Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:20px; }
        .wrap { max-width: 1000px; margin: 0 auto; background:#fff; border:1px solid #ddd; border-radius:10px; padding:16px; }
        h1 { margin:0 0 12px; }
        .row { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px; }
        .row label { font-size:14px; display:grid; gap:4px; }
        input { padding:8px; border:1px solid #ccc; border-radius:6px; min-width:140px; }
        button { padding:9px 14px; border:none; border-radius:6px; background:#5a2e16; color:#fff; cursor:pointer; }
        button:disabled { opacity:.6; cursor:not-allowed; }
        table { width:100%; border-collapse:collapse; margin-top:10px; }
        th, td { border:1px solid #ddd; padding:8px; text-align:left; font-size:14px; }
        th { background:#fafafa; }
        .hint { font-size:13px; color:#555; margin-top:8px; }
        .err { color:#b00020; font-size:13px; margin-top:8px; }
        .legend { display:flex; gap:10px; flex-wrap:wrap; margin:8px 0; font-size:12px; }
        .badge { padding:4px 8px; border-radius:999px; border:1px solid transparent; }
        .lat-good { background:#e8f8ee; color:#1d6f3a; border-color:#b8e7c8; }
        .lat-warn { background:#fff7e6; color:#8a5a00; border-color:#f0d08a; }
        .lat-bad { background:#fdeceb; color:#9f1f1f; border-color:#efb5b1; }
        .lat-cell-good { background:#eaf8ef; color:#1d6f3a; font-weight:700; }
        .lat-cell-warn { background:#fff7e8; color:#8a5a00; font-weight:700; }
        .lat-cell-bad { background:#fdecea; color:#9f1f1f; font-weight:700; }
    </style>
</head>
<body>
    <div class="wrap">
        <h1>Latency Dashboard</h1>
        <div class="row">
            <label>Category ID
                <input id="categoryId" type="number" value="1" min="1" />
            </label>
            <label>Product ID
                <input id="productId" type="number" value="1" min="1" />
            </label>
            <label>Phone
                <input id="phone" type="text" value="9999999999" />
            </label>
            <label>Loops per endpoint
                <input id="loops" type="number" value="10" min="3" max="100" />
            </label>
        </div>
        <div class="row">
            <button id="runBtn">Run Benchmark</button>
        </div>
        <div class="legend">
            <span class="badge lat-good">Good: &lt; 120ms</span>
            <span class="badge lat-warn">Warning: 120ms - 300ms</span>
            <span class="badge lat-bad">Slow: &gt; 300ms</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Endpoint</th>
                    <th>Status</th>
                    <th>Cold (ms)</th>
                    <th>Avg (ms)</th>
                    <th>P50 (ms)</th>
                    <th>P95 (ms)</th>
                    <th>Min/Max (ms)</th>
                </tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
        <p class="hint">Note: This measures browser-visible latency (network + backend), which is what users feel.</p>
        <p id="errBox" class="err"></p>
    </div>

    <script>
        const runBtn = document.getElementById("runBtn");
        const resultBody = document.getElementById("resultBody");
        const errBox = document.getElementById("errBox");

        function p95(values) {
            if (!values.length) return 0;
            const sorted = [...values].sort((a,b) => a - b);
            const idx = Math.max(0, Math.ceil(sorted.length * 0.95) - 1);
            return sorted[idx];
        }

        async function hit(url, method="GET", payload=null) {
            const started = performance.now();
            let status = 0;
            let bodyText = "";
            try {
                const res = await fetch(url, {
                    method,
                    headers: payload ? {"Content-Type":"application/json"} : undefined,
                    body: payload ? JSON.stringify(payload) : undefined
                });
                status = res.status;
                bodyText = await res.text();
            } catch (e) {
                status = 0;
            }
            const ms = performance.now() - started;
            return {status, ms, bodyText};
        }

        function parseJsonSafe(text) {
            try {
                return JSON.parse(text);
            } catch {
                return null;
            }
        }

        async function resolveProductId(categoryId, preferredProductId) {
            const direct = await hit(`/api/products/${preferredProductId}/`);
            if (direct.status === 200) {
                return preferredProductId;
            }

            const categoryList = await hit(`/api/products/categories/${categoryId}/products/`);
            if (categoryList.status === 200) {
                const data = parseJsonSafe(categoryList.bodyText);
                if (Array.isArray(data) && data.length > 0 && data[0].id) {
                    return data[0].id;
                }
            }

            const searchList = await hit(`/api/products/search/?q=a`);
            if (searchList.status === 200) {
                const data = parseJsonSafe(searchList.bodyText);
                if (Array.isArray(data) && data.length > 0 && data[0].id) {
                    return data[0].id;
                }
            }

            return null;
        }

        async function benchmarkEndpoint(name, method, url, payload, loops) {
            const cold = await hit(url, method, payload);
            const warm = [];
            const statuses = new Set([cold.status]);
            for (let i = 0; i < loops; i++) {
                const r = await hit(url, method, payload);
                warm.push(r.ms);
                statuses.add(r.status);
            }
            const avg = warm.reduce((a,b)=>a+b,0) / warm.length;
            const sorted = [...warm].sort((a,b)=>a-b);
            const median = sorted[Math.floor(sorted.length / 2)];
            const errorHint = cold.status >= 400 ? (cold.bodyText || "").slice(0, 120) : "";
            return {
                name,
                status: [...statuses].join(", "),
                cold: cold.ms,
                avg,
                p50: median,
                p95: p95(warm),
                min: Math.min(...warm),
                max: Math.max(...warm),
                errorHint
            };
        }

        function clsFor(ms) {
            if (ms < 120) return "lat-cell-good";
            if (ms <= 300) return "lat-cell-warn";
            return "lat-cell-bad";
        }

        function escAttr(s) {
            return String(s || "").replace(/"/g, "&quot;");
        }

        function row(d) {
            return `
                <tr>
                    <td>${d.name}</td>
                    <td title="${escAttr(d.errorHint)}">${d.status}</td>
                    <td class="${clsFor(d.cold)}">${d.cold.toFixed(2)}</td>
                    <td class="${clsFor(d.avg)}">${d.avg.toFixed(2)}</td>
                    <td class="${clsFor(d.p50)}">${d.p50.toFixed(2)}</td>
                    <td class="${clsFor(d.p95)}">${d.p95.toFixed(2)}</td>
                    <td class="${clsFor(d.max)}">${d.min.toFixed(2)} / ${d.max.toFixed(2)}</td>
                </tr>
            `;
        }

        runBtn.addEventListener("click", async () => {
            errBox.textContent = "";
            resultBody.innerHTML = "";
            runBtn.disabled = true;
            runBtn.textContent = "Running...";
            try {
                const categoryId = Number(document.getElementById("categoryId").value || "1");
                const preferredProductId = Number(document.getElementById("productId").value || "1");
                const phone = document.getElementById("phone").value.trim() || "9999999999";
                const loops = Math.max(3, Number(document.getElementById("loops").value || "10"));
                const productId = await resolveProductId(categoryId, preferredProductId);

                if (!productId) {
                    throw new Error("No valid product found. Add at least one product first.");
                }
                document.getElementById("productId").value = productId;

                // Prime cart once so cart-view latency reflects real cart read path.
                await hit(`/api/cart/add/`, "POST", {
                    phone,
                    customer_name: "Latency User",
                    whatsapp_no: phone,
                    product_id: productId,
                    quantity: 1
                });

                const tests = [
                    ["Category Cards", "GET", `/api/products/category-cards/?section=snacks`, null],
                    ["Products by Category", "GET", `/api/products/categories/${categoryId}/products/`, null],
                    ["Search", "GET", `/api/products/search/?q=cake`, null],
                    ["Cart View", "GET", `/api/cart/view/?phone=${encodeURIComponent(phone)}`, null],
                    ["Cart Add", "POST", `/api/cart/add/`, {
                        phone,
                        customer_name: "Latency User",
                        whatsapp_no: phone,
                        product_id: productId,
                        quantity: 1
                    }]
                ];

                for (const t of tests) {
                    const d = await benchmarkEndpoint(t[0], t[1], t[2], t[3], loops);
                    resultBody.insertAdjacentHTML("beforeend", row(d));
                }
            } catch (e) {
                errBox.textContent = `Error: ${e.message}`;
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = "Run Benchmark";
            }
        });
    </script>
</body>
</html>
