name: thathwamasi

x-app-base: &app_base
  build:
    context: .
    dockerfile: Dockerfile
  image: thathwamasi-app:latest
  env_file:
    - ./deploy/env/hostinger.env
  volumes:
    - static_volume:/app/staticfiles
    - media_volume:/app/media
  restart: unless-stopped

services:
  web:
    <<: *app_base
    command: ["/app/deploy/docker/start-web.sh"]
    depends_on:
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_started
    expose:
      - "8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/api/products/sections/ > /dev/null || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 45s

  worker:
    <<: *app_base
    command: ["/app/deploy/docker/start-worker.sh"]
    depends_on:
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_started

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes", "--maxmemory-policy", "allkeys-lru"]
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 20s
      timeout: 3s
      retries: 5

  postgres:
    image: postgres:16-alpine
    env_file:
      - ./deploy/env/hostinger.env
    expose:
      - "5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 5432 -U \"$${POSTGRES_USER}\" -d \"$${POSTGRES_DB}\" || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 20s

  pgbouncer:
  build:
    context: .
    dockerfile: deploy/docker/pgbouncer/Dockerfile
  image: thathwamasi-pgbouncer:latest
  env_file:
    - ./deploy/env/hostinger.env
  depends_on:
    postgres:
      condition: service_healthy
  ports:
    - "6432:6432"   # Expose pgbouncer outside if needed
  restart: unless-stopped
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -h \"$${PGBOUNCER_DB_HOST}\" -p \"$${PGBOUNCER_DB_PORT}\" -U \"$${PGBOUNCER_DB_USER}\" -d \"$${PGBOUNCER_DB_NAME}\" || exit 1"]
    interval: 20s
    timeout: 5s
    retries: 10
    start_period: 20s

  nginx:
    image: nginx:1.27-alpine
    depends_on:
      web:
        condition: service_healthy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - static_volume:/var/www/static:ro
      - media_volume:/var/www/media:ro
      - certbot_www:/var/www/certbot
      - letsencrypt:/etc/letsencrypt
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1/ || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5

  certbot:
    image: certbot/certbot:latest
    profiles: ["ops"]
    volumes:
      - certbot_www:/var/www/certbot
      - letsencrypt:/etc/letsencrypt

volumes:
  redis_data:
  postgres_data:
  static_volume:
  media_volume:
  certbot_www:
  letsencrypt:
